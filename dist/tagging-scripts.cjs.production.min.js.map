{"version":3,"file":"tagging-scripts.cjs.production.min.js","sources":["../src/utils.ts","../src/auth.ts","../src/infos.ts","../src/dynamic.ts","../src/push.ts","../src/pageble.ts","../src/index.ts","../src/config.ts","../src/clickable.ts"],"sourcesContent":["import { isObject, reduce, merge } from 'lodash';\n\nexport const flattenKeys = (\n  obj: Record<string, unknown>,\n  path: string[] = []\n): Record<string, string> =>\n  !isObject(obj)\n    ? { [path.join('.')]: obj }\n    : reduce(\n        obj,\n        (cum: any, next: any, key: any) =>\n          merge(\n            cum,\n            flattenKeys(next as Record<string, unknown>, [...path, key])\n          ),\n        {}\n      );\n\nexport const replace = (str: string, obj: any) =>\n  str.replaceAll(/\\{([^}]+)\\}/gi, (_, a) =>\n    a.split('.').reduce((b: any, c: any) => b?.[c], obj)\n  );\nexport const getPictureFromDom = (domTarget: any) => {\n  const { dataset, classList = [], id } = domTarget;\n  return {\n    dataset,\n    classList,\n    id,\n  };\n};\n\nexport const getPathname = (locationInstance?: any) => {\n  const location = locationInstance || window.location;\n  const { hash } = getAppConfig();\n  if (hash) {\n    return location.hash.replace('#', '');\n  }\n  return location.pathname;\n};\n\nexport const getAppConfig = () => {\n  return window.__TaggingConfiguration;\n};\n","import * as utils from './utils';\n\nlet auth: any;\n\nexport const getData = (): any => {\n  return auth || utils.getAppConfig().auth || {};\n};\n\nexport const setData = (data: any) => {\n  auth = data;\n};\n","import * as utils from './utils';\n\nlet infos: any;\n\nexport const getData = () => {\n  return infos || utils.getAppConfig().infos || {};\n};\n\nexport const setData = (data: any) => {\n  infos = data;\n};\n","import { set, get } from 'lodash';\nlet dynamic: any = {};\n\nexport const getData = (key: string): any => {\n  return get(dynamic, key, {});\n};\n\nexport const setData = (key: string, data: any) => {\n  set(dynamic, key, data);\n};\n","import { set, get } from 'lodash';\nimport * as utils from './utils';\n\nexport const pushEvent = (scope: any, data: any) => {\n  const { eventLabel, pushTargets = {} } = utils.getAppConfig();\n  // push event\n  set(window, '__TAG_DATA__LAYER', data);\n\n  const eventName = get(scope, eventLabel, scope.type || 'event');\n\n  const targetPipe: string[] = Object.values(pushTargets);\n  targetPipe.forEach(pushFn => {\n    // new function with event name and data as arguments\n    const pushFnWithArgs = new Function('eventName', 'data', pushFn);\n    pushFnWithArgs(eventName, data);\n  });\n};\n","import * as utils from './utils';\nimport * as auth from './auth';\nimport * as infos from './infos';\nimport * as R from 'ramda';\nimport { isEmpty, merge, set } from 'lodash';\nimport * as dynamic from './dynamic';\nimport * as push from './push';\n\nexport const runJob = () => {\n  const page = getActivedPage();\n  if (!page || !isEmpty(page?.dynamicKeys)) {\n    return;\n  }\n  const output = getRuleOutput(true);\n  if (isEmpty(output)) {\n    return;\n  }\n  push.pushEvent(page, output);\n};\n\nexport const runJobWithDynamicData = () => {\n  const output = getRuleOutput(true);\n  if (isEmpty(output)) {\n    return;\n  }\n  push.pushEvent(getActivedPage(), output);\n};\n\nexport const findPage = R.memoizeWith(R.toUpper, (identifier: string): any => {\n  return R.find(R.propEq(identifier, 'id'))(\n    window.__TaggingConfiguration.pages\n  );\n});\n\nexport const getActivedPage = () => {\n  const pathname = utils.getPathname();\n  const page = findPage(pathname);\n  if (!page) {\n    return;\n  }\n  return page;\n};\n\nexport const getActivePageTag = () => {\n  const page = getActivedPage();\n  if (!page) {\n    return;\n  }\n  return page.tag;\n};\n\nexport const getRuleOutput = (decode?: boolean) => {\n  const page = getActivedPage();\n  if (!page) {\n    return;\n  }\n  const { rules, tag, dynamicKeys } = page;\n  const dynamicData = dynamic.getData(utils.getPathname());\n  const data = merge({}, dynamicData, tag, auth.getData(), infos.getData());\n  if (!R.isEmpty(dynamicKeys)) {\n    const keysOfCurrentPage = Object.keys(dynamicData);\n    const diff = R.difference(dynamicKeys, keysOfCurrentPage);\n    if (!R.isEmpty(diff)) {\n      console.warn('[page]missing dynamic keys', diff);\n    }\n  }\n  // pending runtime data\n  const flattenRules = utils.flattenKeys(rules);\n  const output = R.mapObjIndexed(value => {\n    return utils.replace(value, data);\n  }, flattenRules);\n\n  if (decode) {\n    const decodeOutput = {};\n    R.forEachObjIndexed((value, key) => {\n      set(decodeOutput, key, value);\n    }, output);\n    return decodeOutput;\n  }\n\n  return output;\n};\n","import config from './config';\nimport * as clickable from './clickable';\nimport * as pageble from './pageble';\nimport * as utils from './utils';\n\nwindow.__TaggingConfiguration = config;\n\n(() => {\n  if (window.__TaggingConfiguration) {\n    console.log('Tagging is running');\n\n    var pushState = window.history.pushState;\n    window.history.pushState = function() {\n      const beforeIdentifier = utils.getPathname(window.location);\n      pushState.apply(window.history, arguments as any);\n      const afterIdentifier = utils.getPathname(window.location);\n      if (beforeIdentifier !== afterIdentifier) {\n        pageble.runJob();\n      }\n    };\n\n    window.addEventListener('popstate', () => {\n      pageble.runJob();\n    });\n\n    document.addEventListener(\n      'click',\n      e => {\n        clickable.runJob(utils.getPictureFromDom(e.target));\n      },\n      true\n    );\n  }\n})();\n","export default {\n  name: 'app-name',\n  pushTargets: {\n    gtm: 'return dataLayer.push({event: eventName, ...data});',\n  },\n  eventLabel: 'event',\n  auth: {\n    // not sure how many data under auth, this is dynamic setted by develoer\n  },\n  infos: {\n    // this is same as auth\n    region: 'cn',\n  },\n  pages: [\n    {\n      tag: {\n        // this is tag data, all of this tag data are static setted by developer\n        // tag data is a picture of page\n        name: 'this-is-home',\n        section: 'footer',\n      },\n      name: 'xxxxxxx',\n      meta: {},\n      id: '/page2',\n      event: 'page__view',\n      type: 'page',\n      dynamicKeys: ['aaa'],\n      rules: {\n        // this is rules data, all of this rules data are static setted by developer\n        page: {\n          pageName: '{name}:{region}',\n          section: '{name}:{region}-{section}+{aaa}',\n        },\n      },\n      actions: {\n        clicks: [\n          {\n            tag: {\n              buttonName: 'hello-click',\n            },\n            type: 'click',\n            event: 'button__click',\n            meta: {},\n            rules: {\n              button: {\n                buttonName: '{name}:{region}-{buttonName}:{cardname}',\n              },\n            },\n            dynamicKeys: ['cardname'],\n            id: 'domid',\n            class: 'domclass',\n          },\n        ],\n        toggle: [\n          {\n            tag: {},\n            event: 'toggle',\n            id: 'domid',\n            class: 'domclass',\n            type: 'toggle',\n          },\n        ],\n        errors: [\n          {\n            tag: {},\n            event: 'http_error',\n            type: 'http_error',\n          },\n          {\n            tag: {},\n            event: 'form_error',\n            id: 'domid',\n            class: 'domclass',\n            type: 'form_error',\n          },\n        ],\n      },\n    },\n  ],\n};\n","import * as R from 'ramda';\nimport * as pageble from './pageble';\nimport * as utils from './utils';\nimport * as auth from './auth';\nimport * as infos from './infos';\nimport { merge, set } from 'lodash';\nimport * as push from './push';\n\nexport const runJob = ({ dataset = {}, classList, id }: any) => {\n  // get actived page\n  const page = pageble.getActivedPage();\n  if (!page) {\n    return;\n  }\n\n  // get actived button\n  const button = getTargetButton({ classList, id }, page);\n\n  if (!button) {\n    return;\n  }\n  // get page output, get button output\n  const resultOfPage = pageble.getRuleOutput() || {};\n  const resultOfButton = getRuleOutput(button, false, dataset);\n  const result = merge({}, resultOfPage, resultOfButton);\n\n  const data = {};\n  R.forEachObjIndexed((value, key) => {\n    set(data, key, value);\n  }, result);\n\n  push.pushEvent(button, data);\n};\n\nexport const getRuleOutput = (button: any, decode: boolean, dataset: any) => {\n  const { rules, tag, dynamicKeys } = button;\n\n  if (!R.isEmpty(dynamicKeys)) {\n    const keysOfCurrentButton = Object.keys(dataset);\n    const diff = R.difference(dynamicKeys, keysOfCurrentButton);\n    if (!R.isEmpty(diff)) {\n      console.warn('[clickable]missing dynamic keys', diff);\n    }\n  }\n\n  const pageTag = pageble.getActivePageTag();\n  const data = merge(\n    {},\n    dataset,\n    pageTag,\n    tag,\n    auth.getData(),\n    infos.getData()\n  );\n  // pending runtime data\n  const flattenRules = utils.flattenKeys(rules);\n  const output = R.mapObjIndexed(value => {\n    return utils.replace(value, data);\n  }, flattenRules);\n\n  if (decode) {\n    const decodeOutput = {};\n    R.forEachObjIndexed((value, key) => {\n      set(decodeOutput, key, value);\n    }, output);\n    return decodeOutput;\n  }\n  return output;\n};\n\nexport const getTargetButton = (picture: any, page?: any) => {\n  if (!page) {\n    page = pageble.getActivedPage();\n  }\n  if (!page) {\n    return;\n  }\n  const button: any = R.find(\n    R.anyPass([\n      R.propEq(picture.id, 'id'),\n      R.propSatisfies(v => picture.classList?.contains(v), 'class'),\n    ])\n  )(page.actions.clicks);\n\n  if (!button) {\n    return;\n  }\n  return button;\n};\n"],"names":["flattenKeys","obj","path","isObject","reduce","cum","next","key","merge","concat","_ref","join","replace","str","replaceAll","_","a","split","b","c","getPathname","locationInstance","location","window","getAppConfig","hash","pathname","__TaggingConfiguration","getData","utils","auth","infos","dynamic","pushEvent","scope","data","_utils$getAppConfig","eventLabel","_utils$getAppConfig$p","pushTargets","set","eventName","get","type","Object","values","forEach","pushFn","Function","pushFnWithArgs","runJob","page","getActivedPage","isEmpty","dynamicKeys","output","getRuleOutput","push","findPage","R","identifier","pages","decode","rules","tag","dynamicData","keysOfCurrentPage","keys","diff","console","warn","flattenRules","value","decodeOutput","name","gtm","region","section","meta","id","event","pageName","actions","clicks","buttonName","button","class","toggle","errors","log","pushState","history","beforeIdentifier","apply","arguments","afterIdentifier","pageble","addEventListener","document","e","domTarget","_domTarget$classList","dataset","_ref$dataset","classList","picture","v","_picture$classList","contains","getTargetButton","resultOfPage","resultOfButton","keysOfCurrentButton","pageTag","result","clickable","target"],"mappings":"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"}